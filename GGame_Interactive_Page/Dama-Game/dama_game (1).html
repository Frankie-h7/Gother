<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gioco di Dama</title>
    <style>
        /* Reset e variabili CSS per il tema scuro con accenti giallo ocra */
        :root {
            --primary-dark: #1a1a1a;
            --secondary-dark: #2d2d2d;
            --accent-ocra: #DAA520;
            --light-ocra: #F4E4BC;
            --text-light: #ffffff;
            --text-dark: #333333;
            --board-light: #8B4513;
            --board-dark: #654321;
            --player1: #ff4444;
            --player2: #333333;
            --highlight: rgba(218, 165, 32, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr auto;
            overflow-x: hidden;

            /* ============================================== */
            /* SEZIONE AGGIUNTIVA PER OTTIMIZZAZIONE GENERALE */
            /* ============================================== */
            
            /* Disattiva lo Scroll */
            overflow: hidden;

            /* Disabilita selezione testo */
                -webkit-user-select: none; /* Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+/Edge */
                 user-select: none; /* Standard */

            /* Rimuove il flash blu su mobile */
                -webkit-tap-highlight-color: transparent;
                 tap-highlight-color: transparent;
        }

        /* Header con titolo e controlli */
        .game-header {
            text-align: center;
            padding: 20px;
            background: rgba(45, 45, 45, 0.9);
            backdrop-filter: blur(10px);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-ocra);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn {
            background: linear-gradient(45deg, var(--accent-ocra), var(--light-ocra));
            color: var(--text-dark);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4);
        }

        /* Container principale del gioco */
        .game-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            padding: 20px;
            align-items: start;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Pannello di sinistra - Info giocatori */
        .game-info {
            background: rgba(45, 45, 45, 0.9);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-ocra);
        }

        .player-info {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .player-info.active {
            background: rgba(218, 165, 32, 0.2);
            border: 2px solid var(--accent-ocra);
            transform: scale(1.02);
        }

        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent-ocra);
        }

        .player-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .stat {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            color: var(--light-ocra);
        }

        /* Scacchiera centrale */
        .board-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .current-turn {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px 20px;
            background: rgba(218, 165, 32, 0.2);
            border-radius: 25px;
            border: 2px solid var(--accent-ocra);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
            background: var(--accent-ocra);
            border: 4px solid var(--accent-ocra);
            border-radius: 10px;
            width: 480px;
            height: 480px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .square {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .square.light {
            background: var(--board-light);
        }

        .square.dark {
            background: var(--board-dark);
        }

        .square.highlighted {
            background: var(--highlight) !important;
            animation: glow 1s infinite alternate;
        }

        .square.selected {
            background: rgba(255, 255, 255, 0.3) !important;
            border: 3px solid var(--accent-ocra);
        }

        @keyframes glow {
            from { box-shadow: inset 0 0 10px rgba(218, 165, 32, 0.5); }
            to { box-shadow: inset 0 0 20px rgba(218, 165, 32, 0.8); }
        }

        /* Pedine */
        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .piece:hover {
            transform: scale(1.1);
        }

        .piece.player1 {
            background: radial-gradient(circle, var(--player1), #cc0000);
        }

        .piece.player2 {
            background: radial-gradient(circle, var(--player2), #111111);
        }

        .piece.king::after {
            content: "♔";
            font-size: 24px;
            color: var(--accent-ocra);
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Pannello di destra - Statistiche */
        .game-stats {
            background: rgba(45, 45, 45, 0.9);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-ocra);
        }

        .stats-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-ocra);
            margin-bottom: 15px;
            text-align: center;
        }

        .captured-pieces {
            margin: 15px 0;
        }

        .captured-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .captured-display {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .captured-piece {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        /* Modal per fine partita */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--secondary-dark);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 3px solid var(--accent-ocra);
            box-shadow: 0 20px 40px rgba(0,0,0,0.7);
        }

        .modal-title {
            font-size: 2rem;
            color: var(--accent-ocra);
            margin-bottom: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 20px;
            }

            .board {
                width: 320px;
                height: 320px;
            }

            .game-title {
                font-size: 2rem;
            }

            .game-controls {
                gap: 10px;
            }

            .btn {
                padding: 10px 20px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .board {
                width: 280px;
                height: 280px;
            }

            .game-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header del gioco -->
    <div class="game-header">
        <h1 class="game-title">🏁 GIOCO DI DAMA 🏁</h1>
        <div class="game-controls">
            <button class="btn" onclick="startNewGame()">Nuova Partita</button>
            <button class="btn" onclick="toggleGameMode()">Modalità: <span id="game-mode">PvP</span></button>
            <button class="btn" onclick="toggleSound()">Audio: <span id="sound-status">ON</span></button>
        </div>
    </div>

    <!-- Container principale -->
    <div class="game-container">
        <!-- Pannello informazioni giocatori -->
        <div class="game-info">
            <div class="player-info" id="player1-info">
                <div class="player-name">🔴 Giocatore 1 (Rosso)</div>
                <div class="timer" id="player1-timer">10:00</div>
                <div class="player-stats">
                    <div class="stat">Pedine: <span id="player1-pieces">12</span></div>
                    <div class="stat">Dame: <span id="player1-kings">0</span></div>
                    <div class="stat">Mosse: <span id="player1-moves">0</span></div>
                    <div class="stat">Catture: <span id="player1-captures">0</span></div>
                </div>
            </div>

            <div class="player-info" id="player2-info">
                <div class="player-name">⚫ Giocatore 2 (Nero)</div>
                <div class="timer" id="player2-timer">10:00</div>
                <div class="player-stats">
                    <div class="stat">Pedine: <span id="player2-pieces">12</span></div>
                    <div class="stat">Dame: <span id="player2-kings">0</span></div>
                    <div class="stat">Mosse: <span id="player2-moves">0</span></div>
                    <div class="stat">Catture: <span id="player2-captures">0</span></div>
                </div>
            </div>
        </div>

        <!-- Scacchiera centrale -->
        <div class="board-container">
            <div class="current-turn" id="current-turn">Turno del Giocatore 1 (Rosso)</div>
            <div class="board" id="board"></div>
        </div>

        <!-- Pannello statistiche -->
        <div class="game-stats">
            <div class="stats-title">📊 Statistiche Partita</div>
            
            <div class="captured-pieces">
                <div class="captured-title">Catturate da Rosso:</div>
                <div class="captured-display" id="captured-by-player1"></div>
            </div>
            
            <div class="captured-pieces">
                <div class="captured-title">Catturate da Nero:</div>
                <div class="captured-display" id="captured-by-player2"></div>
            </div>

            <div class="stat" style="margin-top: 20px; font-size: 1.1rem;">
                Mosse Totali: <span id="total-moves">0</span>
            </div>
        </div>
    </div>

    <!-- Modal per fine partita -->
    <div class="modal" id="game-modal">
        <div class="modal-content">
            <div class="modal-title" id="modal-title">Fine Partita</div>
            <div id="modal-message"></div>
            <br>
            <button class="btn" onclick="closeModal()">OK</button>
            <button class="btn" onclick="startNewGame()">Nuova Partita</button>
        </div>
    </div>

    <script>
        /**
         * GIOCO DI DAMA - Logica principale
         * Implementazione completa delle regole ufficiali con AI e modalità PvP
         */

        class CheckersGame {
            constructor() {
                // Stato del gioco
                this.board = Array(8).fill().map(() => Array(8).fill(null));
                this.currentPlayer = 1; // 1 = Rosso, 2 = Nero
                this.selectedSquare = null;
                this.gameMode = 'pvp'; // 'pvp' o 'ai'
                this.gameActive = true;
                this.soundEnabled = true;
                
                // Statistiche
                this.stats = {
                    player1: { pieces: 12, kings: 0, moves: 0, captures: 0 },
                    player2: { pieces: 12, kings: 0, moves: 0, captures: 0 },
                    totalMoves: 0
                };
                
                // Timer
                this.timers = {
                    player1: 600, // 10 minuti in secondi
                    player2: 600,
                    active: 1,
                    interval: null
                };
                
                // Inizializzazione
                this.initializeBoard();
                this.createBoardHTML();
                this.startTimer();
                this.updateUI();
            }

            /**
             * Inizializza la scacchiera con le pedine nelle posizioni iniziali
             */
            initializeBoard() {
                // Posiziona le pedine del giocatore 2 (nero) nelle prime 3 righe
                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 8; col++) {
                        if ((row + col) % 2 === 1) {
                            this.board[row][col] = { player: 2, isKing: false };
                        }
                    }
                }

                // Posiziona le pedine del giocatore 1 (rosso) nelle ultime 3 righe
                for (let row = 5; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        if ((row + col) % 2 === 1) {
                            this.board[row][col] = { player: 1, isKing: false };
                        }
                    }
                }
            }

            /**
             * Crea la rappresentazione HTML della scacchiera
             */
            createBoardHTML() {
                const boardElement = document.getElementById('board');
                boardElement.innerHTML = '';

                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const square = document.createElement('div');
                        square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                        square.dataset.row = row;
                        square.dataset.col = col;
                        square.addEventListener('click', (e) => this.handleSquareClick(e));

                        const piece = this.board[row][col];
                        if (piece) {
                            const pieceElement = document.createElement('div');
                            pieceElement.className = `piece player${piece.player}${piece.isKing ? ' king' : ''}`;
                            square.appendChild(pieceElement);
                        }

                        boardElement.appendChild(square);
                    }
                }
            }

            /**
             * Gestisce il click su una casella della scacchiera
             */
            handleSquareClick(event) {
                if (!this.gameActive) return;

                const row = parseInt(event.currentTarget.dataset.row);
                const col = parseInt(event.currentTarget.dataset.col);

                // Se è modalità AI e tocca al giocatore 2, ignora i click
                if (this.gameMode === 'ai' && this.currentPlayer === 2) return;

                if (this.selectedSquare) {
                    // Tentativo di mossa
                    if (this.attemptMove(this.selectedSquare.row, this.selectedSquare.col, row, col)) {
                        this.playSound('move');
                        this.selectedSquare = null;
                        this.clearHighlights();
                        
                        // Controlla se il gioco è finito
                        if (this.checkGameEnd()) {
                            this.endGame();
                            return;
                        }

                        // Cambia turno o gestisce cattura multipla
                        if (!this.mustCaptureAgain(row, col)) {
                            this.switchPlayer();
                            
                            // Se è modalità AI, fai la mossa dell'AI
                            if (this.gameMode === 'ai' && this.currentPlayer === 2) {
                                setTimeout(() => this.makeAIMove(), 1000);
                            }
                        } else {
                            // Deve catturare ancora
                            this.selectedSquare = { row, col };
                            this.highlightValidMoves(row, col);
                        }
                    } else {
                        // Selezione di una nuova pedina
                        this.selectPiece(row, col);
                    }
                } else {
                    // Prima selezione
                    this.selectPiece(row, col);
                }

                this.updateUI();
            }

            /**
             * Seleziona una pedina e evidenzia le mosse valide
             */
            selectPiece(row, col) {
                const piece = this.board[row][col];
                
                if (!piece || piece.player !== this.currentPlayer) {
                    this.selectedSquare = null;
                    this.clearHighlights();
                    return;
                }

                this.selectedSquare = { row, col };
                this.clearHighlights();
                
                // Evidenzia la casella selezionata
                const square = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                square.classList.add('selected');
                
                // Evidenzia le mosse valide
                this.highlightValidMoves(row, col);
            }

            /**
             * Evidenzia le mosse valide per una pedina
             */
            highlightValidMoves(row, col) {
                const validMoves = this.getValidMoves(row, col);
                
                validMoves.forEach(move => {
                    const square = document.querySelector(`[data-row="${move.row}"][data-col="${move.col}"]`);
                    if (square) {
                        square.classList.add('highlighted');
                    }
                });
            }

            /**
             * Rimuove tutti gli highlight dalla scacchiera
             */
            clearHighlights() {
                document.querySelectorAll('.square').forEach(square => {
                    square.classList.remove('highlighted', 'selected');
                });
            }

            /**
             * Calcola le mosse valide per una pedina
             */
            getValidMoves(row, col) {
                const piece = this.board[row][col];
                if (!piece) return [];

                const moves = [];
                const directions = this.getDirections(piece);

                // Prima controlla le catture (obbligatorie)
                const captures = this.getCaptureMovesForPiece(row, col, directions);
                if (captures.length > 0) {
                    return captures; // Se ci sono catture, sono obbligatorie
                }

                // Se non ci sono catture, calcola le mosse normali
                directions.forEach(dir => {
                    const newRow = row + dir.row;
                    const newCol = col + dir.col;

                    if (this.isValidPosition(newRow, newCol) && !this.board[newRow][newCol]) {
                        moves.push({ row: newRow, col: newCol, isCapture: false });
                    }
                });

                return moves;
            }

            /**
             * Ottiene le direzioni di movimento per una pedina
             */
            getDirections(piece) {
                if (piece.isKing) {
                    // Le dame possono muoversi in tutte e 4 le direzioni diagonali
                    return [
                        { row: -1, col: -1 }, { row: -1, col: 1 },
                        { row: 1, col: -1 }, { row: 1, col: 1 }
                    ];
                } else {
                    // Le pedine normali si muovono solo in avanti
                    return piece.player === 1 
                        ? [{ row: -1, col: -1 }, { row: -1, col: 1 }] // Rosso va verso l'alto
                        : [{ row: 1, col: -1 }, { row: 1, col: 1 }];   // Nero va verso il basso
                }
            }

            /**
             * Calcola le mosse di cattura per una pedina
             */
            getCaptureMovesForPiece(row, col, directions) {
                const captures = [];
                const piece = this.board[row][col];

                directions.forEach(dir => {
                    const jumpRow = row + dir.row;
                    const jumpCol = col + dir.col;
                    const landRow = row + (dir.row * 2);
                    const landCol = col + (dir.col * 2);

                    // Controlla se c'è una pedina nemica da saltare
                    if (this.isValidPosition(jumpRow, jumpCol) && 
                        this.isValidPosition(landRow, landCol) &&
                        this.board[jumpRow][jumpCol] &&
                        this.board[jumpRow][jumpCol].player !== piece.player &&
                        !this.board[landRow][landCol]) {
                        
                        captures.push({ 
                            row: landRow, 
                            col: landCol, 
                            isCapture: true,
                            capturedRow: jumpRow,
                            capturedCol: jumpCol
                        });
                    }
                });

                return captures;
            }

            /**
             * Controlla se una posizione è valida sulla scacchiera
             */
            isValidPosition(row, col) {
                return row >= 0 && row < 8 && col >= 0 && col < 8;
            }

            /**
             * Tenta di eseguire una mossa
             */
            attemptMove(fromRow, fromCol, toRow, toCol) {
                const validMoves = this.getValidMoves(fromRow, fromCol);
                const move = validMoves.find(m => m.row === toRow && m.col === toCol);

                if (!move) return false;

                // Esegui la mossa
                const piece = this.board[fromRow][fromCol];
                this.board[toRow][toCol] = piece;
                this.board[fromRow][fromCol] = null;

                // Gestisci cattura
                if (move.isCapture) {
                    this.board[move.capturedRow][move.capturedCol] = null;
                    this.stats[`player${this.currentPlayer}`].captures++;
                    this.stats[`player${this.currentPlayer === 1 ? 2 : 1}`].pieces--;
                    this.playSound('capture');
                    this.addCapturedPiece(this.currentPlayer === 1 ? 2 : 1);
                }

                // Controlla promozione a dama
                if (!piece.isKing && 
                    ((piece.player === 1 && toRow === 0) || 
                     (piece.player === 2 && toRow === 7))) {
                    piece.isKing = true;
                    this.stats[`player${this.currentPlayer}`].kings++;
                    this.playSound('promotion');
                }

                // Aggiorna statistiche
                this.stats[`player${this.currentPlayer}`].moves++;
                this.stats.totalMoves++;

                this.createBoardHTML();
                return true;
            }

            /**
             * Controlla se una pedina deve catturare ancora
             */
            mustCaptureAgain(row, col) {
                const piece = this.board[row][col];
                if (!piece) return false;

                const directions = this.getDirections(piece);
                const captures = this.getCaptureMovesForPiece(row, col, directions);
                
                return captures.length > 0;
            }

            /**
             * Cambia il turno del giocatore
             */
            switchPlayer() {
                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                this.timers.active = this.currentPlayer;
            }

            /**
             * Controlla se il gioco è finito
             */
            checkGameEnd() {
                // Controlla se un giocatore non ha più pedine
                if (this.stats.player1.pieces === 0 || this.stats.player2.pieces === 0) {
                    return true;
                }

                // Controlla se il giocatore corrente può muoversi
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.player === this.currentPlayer) {
                            if (this.getValidMoves(row, col).length > 0) {
                                return false; // Il giocatore può ancora muoversi
                            }
                        }
                    }
                }

                return true; // Nessuna mossa valida
            }

            /**
             * Termina il gioco e mostra il vincitore
             */
            endGame() {
                this.gameActive = false;
                this.stopTimer();

                let winner;
                if (this.stats.player1.pieces === 0) {
                    winner = 2;
                } else if (this.stats.player2.pieces === 0) {
                    winner = 1;
                } else {
                    // Stallo - vince chi ha più pedine
                    winner = this.stats.player1.pieces > this.stats.player2.pieces ? 1 : 2;
                }

                const modal = document.getElementById('game-modal');
                const title = document.getElementById('modal-title');
                const message = document.getElementById('modal-message');

                if (winner === 1) {
                    title.textContent = '🎉 VITTORIA! 🎉';
                    message.innerHTML = `<strong>Il Giocatore 1 (Rosso) ha vinto!</strong><br>
                        Pedine rimaste: ${this.stats.player1.pieces}<br>
                        Catture: ${this.stats.player1.captures}<br>
                        Mosse: ${this.stats.player1.moves}`;
                } else {
                    title.textContent = '🎉 VITTORIA! 🎉';
                    message.innerHTML = `<strong>Il Giocatore 2 (Nero) ha vinto!</strong><br>
                        Pedine rimaste: ${this.stats.player2.pieces}<br>
                        Catture: ${this.stats.player2.captures}<br>
                        Mosse: ${this.stats.player2.moves}`;
                }

                modal.style.display = 'block';
                this.playSound('gameEnd');
            }

            /**
             * Implementazione AI semplice
             */
            makeAIMove() {
                const allMoves = [];

                // Trova tutte le mosse possibili per l'AI (giocatore 2)
                for (let row = 0; row < 8; row++) {
                    for (let col = 0; col < 8; col++) {
                        const piece = this.board[row][col];
                        if (piece && piece.player === 2) {
                            const moves = this.getValidMoves(row, col);
                            moves.forEach(move => {
                                allMoves.push({
                                    fromRow: row,
                                    fromCol: col,
                                    toRow: move.row,
                                    toCol: move.col,
                                    isCapture: move.isCapture,
                                    capturedRow: move.capturedRow,
                                    capturedCol: move.capturedCol
                                });
                            });
                        }
                    }
                }

                if (allMoves.length === 0) {
                    this.endGame();
                    return;
                }

                // Priorità: catture > promozioni > mosse normali
                const captureMoves = allMoves.filter(move => move.isCapture);
                const promotionMoves = allMoves.filter(move => 
                    !move.isCapture && move.toRow === 7 && 
                    this.board[move.fromRow][move.fromCol] && 
                    !this.board[move.fromRow][move.fromCol].isKing
                );

                let selectedMove;
                if (captureMoves.length > 0) {
                    selectedMove = captureMoves[Math.floor(Math.random() * captureMoves.length)];
                } else if (promotionMoves.length > 0) {
                    selectedMove = promotionMoves[Math.floor(Math.random() * promotionMoves.length)];
                } else {
                    selectedMove = allMoves[Math.floor(Math.random() * allMoves.length)];
                }

                // Esegui la mossa dell'AI
                this.selectedSquare = { row: selectedMove.fromRow, col: selectedMove.fromCol };
                if (this.attemptMove(selectedMove.fromRow, selectedMove.fromCol, selectedMove.toRow, selectedMove.toCol)) {
                    this.playSound('move');
                    this.selectedSquare = null;
                    
                    if (this.checkGameEnd()) {
                        this.endGame();
                        return;
                    }

                    if (!this.mustCaptureAgain(selectedMove.toRow, selectedMove.toCol)) {
                        this.switchPlayer();
                    } else {
                        // AI deve catturare ancora
                        setTimeout(() => this.makeAIMove(), 500);
                    }
                }

                this.updateUI();
            }

            /**
             * Aggiunge una pedina catturata alla visualizzazione
             */
            addCapturedPiece(playerCaptured) {
                const container = document.getElementById(`captured-by-player${this.currentPlayer}`);
                const piece = document.createElement('div');
                piece.className = `captured-piece player${playerCaptured}`;
                piece.style.background = playerCaptured === 1 ? 
                    'radial-gradient(circle, var(--player1), #cc0000)' : 
                    'radial-gradient(circle, var(--player2), #111111)';
                container.appendChild(piece);
            }

            /**
             * Avvia il timer del gioco
             */
            startTimer() {
                this.timers.interval = setInterval(() => {
                    if (!this.gameActive) return;

                    this.timers[`player${this.timers.active}`]--;
                    
                    if (this.timers[`player${this.timers.active}`] <= 0) {
                        this.endGameByTime();
                        return;
                    }

                    this.updateTimerDisplay();
                }, 1000);
            }

            /**
             * Ferma il timer
             */
            stopTimer() {
                if (this.timers.interval) {
                    clearInterval(this.timers.interval);
                    this.timers.interval = null;
                }
            }

            /**
             * Termina il gioco per tempo scaduto
             */
            endGameByTime() {
                this.gameActive = false;
                this.stopTimer();

                const winner = this.timers.active === 1 ? 2 : 1;
                const modal = document.getElementById('game-modal');
                const title = document.getElementById('modal-title');
                const message = document.getElementById('modal-message');

                title.textContent = '⏰ TEMPO SCADUTO! ⏰';
                message.innerHTML = `<strong>Il Giocatore ${winner} ${winner === 1 ? '(Rosso)' : '(Nero)'} ha vinto per tempo!</strong><br>
                    Il tempo del Giocatore ${this.timers.active} è scaduto.`;

                modal.style.display = 'block';
                this.playSound('gameEnd');
            }

            /**
             * Aggiorna la visualizzazione del timer
             */
            updateTimerDisplay() {
                ['player1', 'player2'].forEach(player => {
                    const minutes = Math.floor(this.timers[player] / 60);
                    const seconds = this.timers[player] % 60;
                    const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    document.getElementById(`${player}-timer`).textContent = display;
                    
                    // Cambia colore se il tempo sta per scadere
                    const timerElement = document.getElementById(`${player}-timer`);
                    if (this.timers[player] < 60) {
                        timerElement.style.color = '#ff4444';
                        timerElement.style.animation = 'pulse 1s infinite';
                    } else {
                        timerElement.style.color = 'var(--light-ocra)';
                        timerElement.style.animation = 'none';
                    }
                });
            }

            /**
             * Aggiorna l'interfaccia utente
             */
            updateUI() {
                // Aggiorna turno corrente
                const turnElement = document.getElementById('current-turn');
                turnElement.textContent = `Turno del Giocatore ${this.currentPlayer} ${this.currentPlayer === 1 ? '(Rosso)' : '(Nero)'}`;

                // Evidenzia il giocatore attivo
                document.getElementById('player1-info').classList.toggle('active', this.currentPlayer === 1);
                document.getElementById('player2-info').classList.toggle('active', this.currentPlayer === 2);

                // Aggiorna statistiche
                Object.keys(this.stats).forEach(key => {
                    if (key !== 'totalMoves') {
                        Object.keys(this.stats[key]).forEach(stat => {
                            const element = document.getElementById(`${key}-${stat}`);
                            if (element) {
                                element.textContent = this.stats[key][stat];
                            }
                        });
                    }
                });

                document.getElementById('total-moves').textContent = this.stats.totalMoves;
            }

            /**
             * Riproduce un suono se abilitato
             */
            playSound(type) {
                if (!this.soundEnabled) return;

                // Creazione di suoni semplici usando Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                let frequency, duration;
                switch (type) {
                    case 'move':
                        frequency = 800;
                        duration = 0.1;
                        break;
                    case 'capture':
                        frequency = 400;
                        duration = 0.2;
                        break;
                    case 'promotion':
                        frequency = 1200;
                        duration = 0.3;
                        break;
                    case 'gameEnd':
                        frequency = 600;
                        duration = 0.5;
                        break;
                    default:
                        frequency = 500;
                        duration = 0.1;
                }

                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }
        }

        // Istanza globale del gioco
        let game;

        /**
         * Funzioni globali per i controlli
         */
        function startNewGame() {
            const modal = document.getElementById('game-modal');
            modal.style.display = 'none';
            
            if (game) {
                game.stopTimer();
            }
            
            game = new CheckersGame();
        }

        function toggleGameMode() {
            const modeElement = document.getElementById('game-mode');
            const newMode = game.gameMode === 'pvp' ? 'ai' : 'pvp';
            
            game.gameMode = newMode;
            modeElement.textContent = newMode === 'pvp' ? 'PvP' : 'vs AI';
            
            // Se si cambia in modalità AI durante il turno del giocatore 2, fai la mossa dell'AI
            if (newMode === 'ai' && game.currentPlayer === 2 && game.gameActive) {
                setTimeout(() => game.makeAIMove(), 1000);
            }
        }

        function toggleSound() {
            const soundElement = document.getElementById('sound-status');
            game.soundEnabled = !game.soundEnabled;
            soundElement.textContent = game.soundEnabled ? 'ON' : 'OFF';
        }

        function closeModal() {
            document.getElementById('game-modal').style.display = 'none';
        }

        // Inizializza il gioco al caricamento della pagina
        window.addEventListener('load', () => {
            startNewGame();
        });

        // Gestione della chiusura del modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Prevenire il refresh accidentale durante il gioco
        window.addEventListener('beforeunload', (e) => {
            if (game && game.gameActive && game.stats.totalMoves > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>

    <!-- Effetti audio aggiuntivi -->
    <style>
        /* Animazioni aggiuntive per feedback visivo */
        @keyframes moveAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes captureAnimation {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.3) rotate(5deg); }
            50% { transform: scale(1.1) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .piece.moving {
            animation: moveAnimation 0.3s ease-in-out;
        }

        .piece.capturing {
            animation: captureAnimation 0.5s ease-in-out;
        }

        /* Effetti di hover migliorati */
        .square:hover {
            transform: scale(1.02);
            transition: transform 0.2s ease;
        }

        .piece:hover {
            filter: brightness(1.2);
            transform: scale(1.15);
        }

        /* Stili per dispositivi touch */
        @media (hover: none) {
            .square:hover {
                transform: none;
            }
            
            .piece:hover {
                filter: none;
                transform: none;
            }
            
            .square.highlighted {
                animation: pulse 1.5s infinite;
            }
        }

        /* Indicatori visivi aggiuntivi */
        .stats-highlight {
            background: rgba(218, 165, 32, 0.3);
            border-radius: 5px;
            animation: flash 0.5s ease-in-out;
        }

        @keyframes flash {
            0%, 100% { background: rgba(218, 165, 32, 0.1); }
            50% { background: rgba(218, 165, 32, 0.4); }
        }

        /* Miglioramenti per l'accessibilità */
        .piece:focus,
        .square:focus {
            outline: 3px solid var(--accent-ocra);
            outline-offset: 2px;
        }

        .btn:focus {
            outline: 2px solid var(--accent-ocra);
            outline-offset: 2px;
        }

        /* Footer con informazioni */
        .game-footer {
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(218, 165, 32, 0.3);
        }
    </style>

    <!-- Footer -->
    <div class="game-footer">
        🎯 Gioco di Dama - Regole ufficiali implementate | 🎵 Audio integrato | 📱 Responsive Design
    </div>
</body>
</html>
                